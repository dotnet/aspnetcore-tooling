<?xml version="1.0" encoding="utf-8"?>
<Project>
  <PropertyGroup>
    <!-- The one use of ArtifactsDir in Publish.proj adds an additional slash, confusing itself. -->
    <ArtifactsDir Condition=" HasTrailingSlash('$(ArtifactsDir)') ">$(ArtifactsDir.Substring(0, $([MSBuild]::Subtract($(ArtifactsDir.Length), 1))))</ArtifactsDir>

    <PublishDependsOnTargets>$(PublishDependsOnTargets);_PublishingBlobItems</PublishDependsOnTargets>

    <_UploadPathRoot>aspnetcore-tooling</_UploadPathRoot>
  </PropertyGroup>

  <!-- $(InstallersOutputPath) and $(SymbolsOutputPath) are not defined. Root Directory.Build.props is not imported. -->
  <ItemGroup>
    <!-- Prepare for _PublishingBlobItems target. -->
    <_ItemsToPublish Include="$(ArtifactsDir)\packages\**\*.tgz" />
    <_ItemsToPublish Include="$(ArtifactsDir)\LanguageServer\**\*.zip" />
  </ItemGroup>

<Target Name="_PublishingBlobItems">
    <!-- This target is defined in eng/targets/Packaging.targets and included in every project. -->
    <MSBuild Projects="$(RepoRoot)src\Razor\src\Microsoft.AspNetCore.Razor.Language\Microsoft.AspNetCore.Razor.Language.csproj"
        Targets="_GetPackageVersionInfo"
        SkipNonexistentProjects="false">
      <Output TaskParameter="TargetOutputs" ItemName="_ResolvedPackageVersionInfo" />
    </MSBuild>

    <PropertyGroup>
      <_PackageVersion>@(_ResolvedPackageVersionInfo->'%(PackageVersion)')</_PackageVersion>
    </PropertyGroup>

    <ItemGroup>
      <ItemsToPushToBlobFeed Include="@(_ItemsToPublish)">
        <IsShipping>false</IsShipping>
        <ManifestArtifactData>ShipInstaller=dotnetcli;NonShipping=true</ManifestArtifactData>
        <PublishFlatContainer>true</PublishFlatContainer>
        <RelativeBlobPath>$(_UploadPathRoot)/$(_PackageVersion)/%(Filename)%(Extension)</RelativeBlobPath>
      </ItemsToPushToBlobFeed>
    </ItemGroup>
  </Target>
</Project>